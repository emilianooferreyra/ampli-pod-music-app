# Architecture

## Project Overview

**Intune App** is a music streaming platform currently in active development. The project is transitioning from a single backend application to a full-stack monorepo architecture.

### Current State (Transition Phase)

- **Active codebase**: `pod-back/` - Express.js + TypeScript + MongoDB backend
- **Planned structure**: Monorepo with Turborepo + pnpm workspaces
- **Future migration**: Express → Hono.js, MongoDB/Mongoose → PostgreSQL/Drizzle

## Backend Structure

The backend follows a traditional MVC-like pattern with the following layers:

```
pod-back/src/
├── controllers/    # Request handlers (thin layer, call business logic)
├── models/         # Mongoose schemas and document types
├── routers/        # Express route definitions
├── middleware/     # Auth, validation, file parsing, error handling
├── types/          # TypeScript interfaces for requests/responses
├── utils/          # Helpers, validation schemas, mail utilities
├── mail/           # Email templates and assets
├── cloud/          # Cloudinary configuration
└── db/             # MongoDB connection
```

## Key Architectural Patterns

### Path Aliases
The codebase uses `@/*` to reference `./src/*` (configured in tsconfig.json). Always use these aliases instead of relative imports.

### Validation Flow
1. Request → Router (with Zod validation middleware)
2. Validator middleware checks schema
3. Controller receives typed, validated data
4. Controller calls business logic
5. Response returned

### Authentication
JWT-based with token array in User model (allows multi-device sessions). Middleware `mustAuth` validates and attaches `req.user` and `req.token`.

### File Uploads
Multer stores files in memory, then uploads to Cloudinary. Audio files and poster images are handled separately.

### Email System
Uses Nodemailer with Mailtrap for development. Templates are HTML with embedded images via `cid:` attachments.

## Data Models

### Core Entities
- **User**: Authentication, profile, social features (followers/followings)
- **Audio**: Music files with metadata, likes, categories
- **Playlist**: User-created collections with public/private visibility
- **AutoGeneratedPlaylist**: System-generated collections (updated daily via cron)
- **Favorite**: User's favorited audios
- **History**: Playback history with progress tracking
- **EmailVerificationToken**: Time-limited tokens (1 hour expiry)
- **PasswordResetToken**: Password reset tokens with bcrypt hashing

### Important Relationships
- Users can follow other users (many-to-many via `followers`/`followings` arrays)
- Audios belong to users (`owner` field)
- Playlists contain audio references and have visibility settings
- History tracks user listening patterns for recommendations

## Scheduled Tasks

A cron job runs daily at midnight (`utils/schedule.ts`) to generate curated playlists based on audio popularity and categories. Uses MongoDB aggregation to sample and group audios.

## Token Management

- **Email verification tokens**: 6-digit OTP, bcrypt hashed, auto-expire after 1 hour (MongoDB TTL index)
- **Password reset tokens**: 36-byte hex string, bcrypt hashed, manually deleted after use
- **JWT tokens**: Stored in user's `tokens` array for multi-session support

## Code Patterns

### Validation with Zod

All request validation uses Zod schemas in `utils/validationSchema.ts`. The `validate()` middleware automatically checks and returns 422 on failure.

```typescript
// Router
router.post('/create', validate(CreateUserSchema), create);

// Schema
export const CreateUserSchema = z.object({
  name: z.string().trim().min(3).max(20),
  email: z.string().email(),
  password: z.string().min(8).regex(/^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#\$%\^&\*])/)
});
```

### File Upload Pattern

Audio and poster images use the `fileParser` middleware:

```typescript
router.post('/create', mustAuth, isVerified, fileParser, validate(AudioValidationSchema), createAudio);
```

In controllers, access files via `req.files` (multer), convert to base64 data URIs, then upload to Cloudinary with appropriate transformations.

### Error Handling

Centralized error handler catches:
- MongoDB duplicate key errors (code 11000) → 409 Conflict
- All other errors → 500 with error message

Use `throw new Error()` in controllers/middleware; the error handler will catch and format responses.

### Audio Categories

Fixed set of categories defined in `utils/audio-category.ts`:
- Arts, Business, Education, Entertainment, Kids & Family, Music, Science, Tech, Others

These are used for content organization and auto-generated playlist creation.

## Security Considerations

### Current Implementation
- Password hashing with bcrypt (10 rounds)
- JWT token signing and validation
- Email verification flow
- Input validation with Zod
- File type validation in uploads

### Not Yet Implemented
- Rate limiting on auth endpoints
- CORS configuration
- Security headers (Helmet)
- NoSQL injection protection
- Comprehensive request logging
- Environment variable validation on startup

When adding security features, prioritize rate limiting on `/auth/*` endpoints to prevent brute force attacks.

## Testing Strategy (Planned)

When implementing tests:
- **Unit tests**: Services layer with Vitest
- **Integration tests**: API endpoints with `hono/testing` (post-migration)
- **E2E tests**: Network-level validation with Supertest (optional)

Tests should focus on services, not controllers, as services contain the actual business logic.
